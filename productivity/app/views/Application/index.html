#{extends 'main.html' /}
#{set title:'Dashboard for ' + session.username /}
#{jqui /}

#{set 'moreStyles'}
  #{get 'moreStyles'/}
  <link rel="stylesheet" href="@{'/public/stylesheets/Timeglider.css'}" type="text/css" media="screen, projection" title="no title" charset="utf-8">
  <link rel="stylesheet" href="@{'/public/stylesheets/jquery-ui-timepicker-addon.css'}" type="text/css" media="screen, projection" title="no title" charset="utf-8">
  <style type="text/css" media="screen">
	#tl-pres {margin:32px; height:500px;}
    .column { width: 100%; float: left; padding-bottom: 20px; padding-top: 20px; }
	.portlet { margin: 0 1em 1em 0; }
	.portlet-header { margin: 0.3em; padding-bottom: 4px; padding-left: 0.2em; }
	.portlet-header .ui-icon { float: right; }
	.portlet-content { padding: 0.4em; }
	.ui-sortable-placeholder { border: 1px dotted black; visibility: visible !important; height: 50px !important; }
	.ui-sortable-placeholder * { visibility: hidden; }
  </style>
#{/set}

#{set 'moreScripts'}
  #{get 'moreScripts'/}
  #{script "jquery-ui-timepicker-addon.js" /}
  #{script "timeglider.min.js" /}
  #{script "jquery.tmpl.min.js" /}
  #{script "knockout-latest.debug.js" /}
  #{script "knockout.mapping-latest.js" /}
#{/set}

<div class="column">

	<div id="statistics-container" class="portlet">
		<div class="portlet-header">Statistics</div>
		<div class="portlet-content">
			There are ${unassigned} unassigned #{a @Activities.unassigned()}activities#{/a}.
		</div>
	</div>


	<div id="timeline-container" class="portlet">
		<div class="portlet-header">Timeline</div>
		<div class="portlet-content">
			<div id="tl-controls">
				<label for="focus-date">Focus on date and time: </label>
				<input type="text" id="focus-date" name="focus-date" size="20" value="" data-bind="value: fDate"/>
				<div id="tl-pres" data-bind='event: { "mediator": feedFocusBack, "mediator.zoomLevelChange": feedFocusBack }'></div>
			</div>
		</div>
	</div>

</div>

<script type="text/javascript">
//
// Timeline controls model
//
var tg1_actor = null;

/*** ndigits - field width */
Number.prototype.pad = function(ndigits) {
    var n = this;
    var p = isNaN(ndigits) ? 2 : ndigits;
    var zeros = $.map(new Array(p - 1), function () { return "0" }).join("");
    if( p > 0)
        return (zeros + n).substring(n.toString().length - p + 1);
    else
        return n;
};

var tl_controls = function () {
    var d = new Date();
    this.fDate = ko.observable(d.getFullYear() + '-' + (d.getMonth() + 1).pad() + '-' + d.getDate().pad() + ' ' + d.getHours().pad() + ':' + d.getMinutes().pad() + ':' + d.getSeconds().pad());
    this.timeline = ko.dependentObservable(function() {
        try {
            tg1_actor.goTo(this.fDate(), 20);
        } catch (ex) {
            /* discard */
        }
    }, this);
    this.feedFocusBack = function () {
        console.log("feedFocusBack");
        this.fDate('got it');
    };
};

$(function () {
    //
    // Portlets layout handling
    //
    $( ".column" ).sortable({
        connectWith: ".column",
        axis: "y",
        update: function(event, ui) {
            // TODO: (re)store user layout changes
        }
    });

    $( ".portlet" ).addClass( "ui-widget ui-widget-content ui-helper-clearfix ui-corner-all" )
            .find( ".portlet-header" )
            .addClass( "ui-widget-header ui-corner-all" )
            .prepend( "<span class='ui-icon ui-icon-minusthick'></span>")
            .end()
            .find( ".portlet-content" );

    $( ".portlet-header .ui-icon" ).click(function() {
        $( this ).toggleClass( "ui-icon-minusthick" ).toggleClass( "ui-icon-plusthick" );
        $( this ).parents( ".portlet:first" ).find( ".portlet-content" ).toggle();
    });

    $( ".column" ).disableSelection();

    //
    // Timeglider timeline portlet
    //
    tg1 = $("#tl-pres").timeline({
        data_source:"@{Application.timeline()}",
        min_zoom: 1,
        max_zoom: 60,
        icon_folder: "/public/stylesheets"
    });

    tg1_actor = tg1.data("timeline");

    $("#focus-date").datetimepicker({ dateFormat: 'yy-mm-dd' , timeFormat: 'hh:mm:ss', showSecond: true } );

    ko.applyBindings(tl_controls(), document.getElementById("tl-controls"));
});
</script>
